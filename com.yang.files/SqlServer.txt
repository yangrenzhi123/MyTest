declare @table nvarchar(max)
set @table='DeptData2005';
declare @identity nvarchar(max)
declare @sql nvarchar(max)
declare @pk nvarchar(max)
declare @ispk int
--查找identity字段
select @identity=name from sys.COLUMNS where object_id = (select object_id from  sys.TABLES where name = @table) and is_identity = 1
if @identity is null
       return ;
--判断是不是主键
SELECT @pk = SYSCOLUMNS.name
FROM SYSCOLUMNS,SYSOBJECTS,SYSINDEXES,SYSINDEXKEYS
WHERE SYSCOLUMNS.id = object_id(@table) --syscolumns.id为该列所属的表对象ID
AND SYSOBJECTS.xtype = 'PK' --sysobjects.xtype对象类型
AND SYSOBJECTS.parent_obj = SYSCOLUMNS.id
AND SYSINDEXES.id = SYSCOLUMNS.id
AND SYSOBJECTS.name = SYSINDEXES.name
AND SYSINDEXKEYS.id = SYSCOLUMNS.id
AND SYSINDEXKEYS.indid = SYSINDEXES.indid   --同一表的同一列，可能建有不同类型的索引
AND SYSCOLUMNS.colid = SYSINDEXKEYS.colid
if @identity=@pk
 set @ispk=1
else
 set @ispk=0
--临时字段
set @sql = 'alter table '+@table+' add tttemp int'
EXEC SP_EXECUTESQL @sql
--备份数据
set @sql = 'update '+@table+' set tttemp = '+@identity
EXEC SP_EXECUTESQL @sql
--删除主键约束
if @ispk=1
begin
       DECLARE @sy nvarchar(max);
       select @sy=name from sys.indexes where object_id = (select object_id from sys.TABLES where name = @table)
       set @sql = 'ALTER TABLE '+@table+' DROP CONSTRAINT ' + @sy;
       EXEC SP_EXECUTESQL @sql
end
--删除列
set @sql = 'alter table '+@table+' drop column '+@identity;
EXEC SP_EXECUTESQL @sql
--重命名
set @sql = @table + '.tttemp'
exec sp_rename @sql, @identity, 'COLUMN'
--设非空
set @sql = 'alter table '+@table+' alter column '+@identity+' int not null'
EXEC SP_EXECUTESQL @sql
--加主键约束
if @ispk=1
       begin
       set @sql = 'ALTER TABLE '+@table+' ADD PRIMARY KEY CLUSTERED ('+@identity+')'
       EXEC SP_EXECUTESQL @sql
end